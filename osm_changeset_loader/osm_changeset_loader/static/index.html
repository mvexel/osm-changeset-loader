<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet Your Mappers</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        #map {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }

        .loading {
            display: none;
        }
    </style>
</head>

<body>
    <h1>OSM Mapper Activity Viewer</h1>
    <div><input id="osmUrlInput" type="text" placeholder="https://www.openstreetmap.org/#map=16/40.73950/-111.86464"
            aria-label="Paste an OSM map URL" />
        <input type="button" aria-label="meet my mappers!" onclick="fetchMappers()">
    </div>
    <div class="loading">Loading data...</div>
    <div id="results">
    </div>

    <script>

        function osmUrlToBbox(osmUrl) {
            const match = osmUrl.match("/#map=(\d+)/(\-?\d +\.\d +) / (\-?\d +\.\d +) /");
            if (!match) return null;

            const zoom = parseInt(match[1], 10);
            const lat = parseFloat(match[2]);
            const lon = parseFloat(match[3]);

            // Tile size at zoom 0 is 360 degrees; it halves every zoom level
            const degreesPerTile = 360 / Math.pow(2, zoom);

            // Approximate bounding box using half of the tile size
            const halfSize = degreesPerTile / 2;
            return {
                minLat: lat - halfSize,
                maxLat: lat + halfSize,
                minLon: lon - halfSize,
                maxLon: lon + halfSize
            };
        }

        async function fetchMappers(bounds) {
            const osmUrl = document.getElementById("osmUrlInput").textContent;
            console.log(osmUrl);
            const loading = document.querySelector('.loading');
            loading.style.display = 'block';

            try {
                const response = await fetch(`/mappers/?min_lon=${bounds.getWest()}&max_lon=${bounds.getEast()}&min_lat=${bounds.getSouth()}&max_lat=${bounds.getNorth()}`);
                const data = await response.json();
                displayMappers(data);
            } catch (error) {
                console.error('Error fetching mapper data:', error);
                alert('Error fetching mapper data. Please try again.');
            } finally {
                loading.style.display = 'none';
            }
        }

    </script>
</body>

</html>